<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者ダッシュボード - 学習管理システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 1.5rem;
        }

        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            color: #666;
            font-size: 0.9rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: #f8f9fa;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            font-size: 2rem;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .password-display {
            font-family: monospace;
            color: #666;
        }

        .export-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .date-range {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .password-strength {
            margin-top: 0.5rem;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            transition: all 0.3s;
            width: 0%;
        }

        .password-strength-bar.weak {
            width: 33%;
            background: #dc3545;
        }

        .password-strength-bar.medium {
            width: 66%;
            background: #ffc107;
        }

        .password-strength-bar.strong {
            width: 100%;
            background: #28a745;
        }

        .password-requirements {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .password-requirements ul {
            margin-left: 1.5rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>学習管理システム - 管理者ダッシュボード</h1>
        <div class="header-right">
            <div class="user-info">
                <span id="userName"></span> (<span id="userRole"></span>)
            </div>
            <button class="btn btn-secondary" onclick="logout()">ログアウト</button>
        </div>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">概要</button>
            <button class="nav-tab" onclick="switchTab('students')">学生管理</button>
            <button class="nav-tab" onclick="switchTab('schools')">学校管理</button>
            <button class="nav-tab" onclick="switchTab('admins')">管理者管理</button>
            <button class="nav-tab" onclick="switchTab('reports')">レポート</button>
            <button class="nav-tab" onclick="switchTab('datasync')">データ同期</button>
        </div>

        <!-- 概要タブ -->
        <div id="overview" class="tab-content active">
            <h2 style="margin-bottom: 1.5rem;">システム概要</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>総学生数</h3>
                    <p id="totalStudents">0</p>
                </div>
                <div class="stat-card">
                    <h3>登録学校数</h3>
                    <p id="totalSchools">0</p>
                </div>
                <div class="stat-card">
                    <h3>管理者数</h3>
                    <p id="totalAdmins">0</p>
                </div>
                <div class="stat-card">
                    <h3>本日の出席数</h3>
                    <p id="todayAttendance">0</p>
                </div>
            </div>
        </div>

        <!-- 学生管理タブ -->
        <div id="students" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>学生管理</h2>
                <button class="btn btn-primary" onclick="showAddStudentModal()">学生を追加</button>
            </div>
            <div id="studentsTable"></div>
        </div>

        <!-- 学校管理タブ -->
        <div id="schools" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>学校管理</h2>
                <button class="btn btn-primary" onclick="showAddSchoolModal()">学校を追加</button>
            </div>
            <div id="schoolsTable"></div>
        </div>

        <!-- 管理者管理タブ -->
        <div id="admins" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>管理者管理</h2>
                <button class="btn btn-primary" onclick="showAddAdminModal()" id="addAdminBtn">管理者を追加</button>
            </div>
            <div id="adminsTable"></div>
        </div>

        <!-- レポートタブ -->
        <div id="reports" class="tab-content">
            <h2 style="margin-bottom: 1.5rem;">レポート</h2>
            <div class="export-section">
                <h3 style="margin-bottom: 1rem;">期間設定</h3>
                <div class="date-range">
                    <label>期間:</label>
                    <input type="date" id="startDate">
                    <span>～</span>
                    <input type="date" id="endDate">
                    <button class="btn btn-primary" onclick="setPeriod()" style="margin-left: 1rem;">期間を設定</button>
                </div>
                <div id="periodDisplay" style="margin-top: 1rem; padding: 0.75rem; background: #e7f3ff; border-radius: 4px; display: none;">
                    <strong>設定期間:</strong> <span id="periodText"></span>
                </div>
            </div>
            <div class="export-section" id="exportButtons" style="display: none; margin-top: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">データエクスポート</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <button class="btn btn-primary" onclick="exportStudentData()">
                        📋 学生データ
                    </button>
                    <button class="btn btn-primary" onclick="exportSchoolLearningData()">
                        🏫 学校学習データ
                    </button>
                    <button class="btn btn-primary" onclick="exportStudentLearningTotal()">
                        📊 学生学習データ（合計）
                    </button>
                    <button class="btn btn-primary" onclick="exportStudentLearningDetail()">
                        📝 学生学習データ（個人）
                    </button>
                </div>
            </div>
        </div>
        <!-- データ同期タブ -->
        <div id="datasync" class="tab-content">
            <h2 style="margin-bottom: 1.5rem;">データ同期</h2>
            
            <!-- 19時自動下校処理 -->
            <div class="export-section" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">🕖 19時自動下校処理</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    本日の未下校者を19:00で一括下校処理します。<br>
                    毎日19時以降に実行してください。
                </p>
                <button class="btn btn-primary" onclick="processAutoCheckout()" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    ⏰ 本日の未下校者を19時で処理
                </button>
                <div id="autoCheckoutResult" style="margin-top: 1rem;"></div>
            </div>

            <!-- データエクスポート -->
            <div class="export-section" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">📤 データエクスポート</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    全データ（学生、学校、管理者、出席記録）をファイルに保存します。<br>
                    パソコン → iPad へのデータ転送に使用します。
                </p>
                <button class="btn btn-primary" onclick="exportAllData()" style="font-size: 1.1rem;">
                    💾 全データをエクスポート
                </button>
            </div>

            <!-- データインポート -->
            <div class="export-section">
                <h3 style="margin-bottom: 1rem;">📥 データインポート</h3>
                <p style="margin-bottom: 1rem; color: #666;">
                    エクスポートしたファイルからデータを読み込みます。<br>
                    <strong style="color: #dc3545;">注意: 現在のデータは上書きされます！</strong>
                </p>
                <input type="file" id="importFile" accept=".json" style="margin-bottom: 1rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <br>
                <button class="btn btn-warning" onclick="importAllData()" style="font-size: 1.1rem;">
                    📂 データをインポート
                </button>
                <div id="importResult" style="margin-top: 1rem;"></div>
            </div>

            <!-- 使用方法 -->
            <div style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                <h3 style="margin-bottom: 1rem; color: #667eea;">📖 運用フロー</h3>
                <ol style="margin-left: 1.5rem; line-height: 2;">
                    <li><strong>朝（パソコン）</strong>: 全データをエクスポート → ファイルをiPadに転送</li>
                    <li><strong>朝（iPad）</strong>: データをインポート</li>
                    <li><strong>日中（iPad）</strong>: QRコードで登校・下校を記録</li>
                    <li><strong>19時過ぎ（iPad）</strong>: 「19時自動下校処理」ボタンをクリック</li>
                    <li><strong>夜（iPad）</strong>: 全データをエクスポート → ファイルをパソコンに転送</li>
                    <li><strong>夜（パソコン）</strong>: データをインポート</li>
                </ol>
                <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                    💡 ヒント: ファイル転送にはAirDrop、メール、クラウドストレージ（Googleドライブ等）が便利です
                </p>
            </div>
        </div>
    </div>

    <!-- 学生追加/編集モーダル -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="studentModalTitle">学生を追加</h2>
                <button class="close-modal" onclick="closeModal('studentModal')">&times;</button>
            </div>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-group">
                    <label>名前（カタカナ苗字）*</label>
                    <input type="text" id="studentLastName" required pattern="[\u30A0-\u30FF]+" title="カタカナのみ入力してください">
                </div>
                <div class="form-group">
                    <label>学校*</label>
                    <select id="studentSchool" required></select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('studentModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 学校追加/編集モーダル -->
    <div id="schoolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="schoolModalTitle">学校を追加</h2>
                <button class="close-modal" onclick="closeModal('schoolModal')">&times;</button>
            </div>
            <form id="schoolForm">
                <input type="hidden" id="schoolId">
                <div class="form-group">
                    <label>学校名*</label>
                    <input type="text" id="schoolName" required>
                </div>
                <div class="form-group">
                    <label>ログインID*</label>
                    <input type="text" id="schoolLoginId" required>
                </div>
                <div class="form-group">
                    <label>パスワード <span style="font-size: 0.85rem; color: #666;">(編集時は変更する場合のみ入力)</span></label>
                    <input type="password" id="schoolPassword" placeholder="8文字以上">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('schoolModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 管理者追加モーダル -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>管理者を追加</h2>
                <button class="close-modal" onclick="closeModal('adminModal')">&times;</button>
            </div>
            <form id="adminForm">
                <div class="form-group">
                    <label>名前*</label>
                    <input type="text" id="adminName" required>
                </div>
                <div class="form-group">
                    <label>メールアドレス*</label>
                    <input type="email" id="adminEmail" required>
                </div>
                <div class="form-group">
                    <label>役割*</label>
                    <select id="adminRole" required>
                        <option value="admin">管理者</option>
                        <option value="super_admin">総管理者</option>
                    </select>
                </div>
                <div class="alert alert-success">
                    初回ログイン時にパスワードを設定します
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('adminModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">追加</button>
                </div>
            </form>
        </div>
    </div>

